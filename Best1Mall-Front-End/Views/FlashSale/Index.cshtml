@using Best1Mall_Front_End.Models.Flashsale
@model List<FlashSaleViewModel>

<!-- Thêm Swiper CSS -->
@* <link href="https://unpkg.com/swiper/swiper-bundle.min.css" rel="stylesheet"> *@

@functions {
    string ToSeoUrl(string name)
    {
        return RemoveUnicode(RemoveSpecialCharacters(name)).Replace(" ", "-").ToLower();
    }

    string RemoveUnicode(string text)
    {
        var normalized = text.Normalize(System.Text.NormalizationForm.FormD);
        var chars = normalized.Where(c => System.Globalization.CharUnicodeInfo.GetUnicodeCategory(c) != System.Globalization.UnicodeCategory.NonSpacingMark);
        return new string(chars.ToArray()).Normalize(System.Text.NormalizationForm.FormC);
    }

    string RemoveSpecialCharacters(string input)
    {
        return System.Text.RegularExpressions.Regex.Replace(input, "[^a-zA-Z0-9\\s-]", "");
    }

    string FormatCurrency(double? amount)
    {
        return (amount.HasValue && amount > 0) ? string.Format("{0:#,0} đ", amount.Value) : "Giá liên hệ";
    }
    string GetFullImageUrl(string avatar)
    {
        if (string.IsNullOrEmpty(avatar))
        {
            return "/images/no-image.png"; // fallback ảnh mặc định
        }

        if (avatar.StartsWith("http") || avatar.StartsWith("data:image"))
        {
            return avatar; // Giữ nguyên nếu đã là URL hoặc base64
        }

        return "https://static-image.adavigo.com" + avatar; // Gắn domain tĩnh
    }
}

<section class="homepage">
    <div class="max-w-[1230px] mx-auto my-4 px-[15px]">
        <div class="breadcrumb my-4 ">
            <ul class="flex items-center gap-3 font-normal">
                <li><a href="/">Trang chủ</a></li>
                <li><a href="/flashsale" class="text-color-base">Flashsale</a></li>
            </ul>
        </div>


        @if (Model.Any())
        {
            var now = DateTime.UtcNow; // Lấy thời gian hiện tại (UTC)
            var validFlashSales = Model.Where(f => f.fromdate <= now && f.todate >= now).ToList(); // Lọc tất cả Flash Sale hợp lệ
            var firstValidFlashSale = validFlashSales.FirstOrDefault(); // Lấy Flash Sale hợp lệ đầu tiên

            @await Html.PartialAsync("_SuperFlashSale", ViewBag.SuperSaleProducts as List<FlashSaleProductResposeModel>)



            <!-- Hiển thị Flash Sale còn lại trong Swiper -->
            @foreach (var flashsale in validFlashSales) // Bắt đầu từ Flash Sale thứ hai hợp lệ
            {
                string imgSrc = GetFullImageUrl(flashsale.banner);
                <div class="my-6 md:my-10">
                    <div class="flex justify-between flex-wrap gap-2 mb-3">
                        <h2 class="text-sky-900 font-medium uppercase"><a href="#">@flashsale.name</a></h2>
                    </div>

                    <div class="h-[1px] w-full bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500"></div>

                    <div style="margin-top:20px">
                        <div class="md:rounded-3xl rounded-xl bg-white p-3 mb-6">
                            <img src="@imgSrc" alt="@flashsale.name"
                                 class="rounded-tl-xl rounded-tr-xl md:rounded-tl-3xl md:rounded-tr-3xl w-full">
                            <!-- Swiper -->
                            <div class="relative mt-3">
                                <div class="flash-sale-swiper">
                                    <div class="swiper">
                                        <div class="swiper-wrapper">
                                            @foreach (var product in flashsale.Products)
                                            {
                                                string seoUrl = $"/san-pham/{ToSeoUrl(product.name)}--{product._id}";
                                                string discountText = $"-{product.discountvalue}%";
                                                string ratingDisplay = (product.rating.HasValue && product.rating > 0) ? product.rating.Value.ToString("0.0") + "★" : "";
                                                string reviewCountDisplay = (product.review_count.HasValue && product.review_count > 0) ? $"({product.review_count})" : "";
                                                string imgSrc2 = GetFullImageUrl(product.avatar);
                                                <div class="swiper-slide pt-3">
                                                    <div class="bg-white rounded-xl p-2 text-slate-800 relative border border-gray-100 h-full pb-14">
                                                        <a href="@seoUrl">
                                                            @* 👇 Đây là phần phân nhánh hiển thị tag: *@
                                                            @if (product.super_sale == true)
                                                            {
                                                                <div class="absolute -top-1 z-10 left-1 bg-[url(assets/images/icon/tag-sieusale.png)] bg-contain bg-no-repeat text-white text-xs px-2 w-[70px] h-[30px] py-1">
                                                                    Siêu Sale
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="absolute -top-1 z-10 left-1 bg-[url(assets/images/icon/tag1.png)] bg-contain bg-no-repeat text-white text-xs px-2 w-[50px] h-[30px] py-1">
                                                                    @discountText
                                                                </div>
                                                            }
                                                            <div class="relative aspect-[1/1] overflow-hidden rounded-lg">
                                                                <img src="@imgSrc2" alt="@product.name" class="absolute inset-0 w-full h-full object-cover" />
                                                            </div>
                                                            <p class="text-sm line-clamp-2 font-medium mt-2">@product.name</p>
                                                            <div class="absolute bottom-2 w-full px-2 left-0">
                                                                <div class="text-rose-600 font-bold mt-1">@String.Format("{0:N0}", product.amount_after_flashsale) đ</div>
                                                                <div class="flex items-center justify-between">
                                                                    <div class="text-xs line-through text-slate-400">@String.Format("{0:N0}", product.amount) đ</div>
                                                                    <div class="text-xs text-yellow-500 mt-1">
                                                                        @Html.Raw(ratingDisplay) <span class="text-slate-400">@Html.Raw(reviewCountDisplay)</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>
                                            }
                                            <div class="swiper-slide pt-3">
                                                <div class="flex items-center justify-center w-full h-full">
                                                    <a href="/flashsale/products/@flashsale.flashsale_id" class="flex items-center gap-2 text-blue-500 justify-center">
                                                        Xem tất cả
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                                            <path d="M12.773 9.39804L7.14804 15.023C7.09578 15.0753 7.03373 15.1168 6.96545 15.145C6.89716 15.1733 6.82398 15.1879 6.75007 15.1879C6.67616 15.1879 6.60297 15.1733 6.53469 15.145C6.46641 15.1168 6.40436 15.0753 6.3521 15.023C6.29984 14.9708 6.25838 14.9087 6.2301 14.8404C6.20181 14.7722 6.18726 14.699 6.18726 14.6251C6.18726 14.5512 6.20181 14.478 6.2301 14.4097C6.25838 14.3414 6.29984 14.2794 6.3521 14.2271L11.5798 9.00007L6.3521 3.77304C6.24655 3.66749 6.18726 3.52434 6.18726 3.37507C6.18726 3.2258 6.24655 3.08265 6.3521 2.9771C6.45765 2.87155 6.6008 2.81226 6.75007 2.81226C6.89934 2.81226 7.04249 2.87155 7.14804 2.9771L12.773 8.6021C12.8253 8.65434 12.8668 8.71638 12.8951 8.78466C12.9234 8.85295 12.938 8.92615 12.938 9.00007C12.938 9.07399 12.9234 9.14719 12.8951 9.21547C12.8668 9.28376 12.8253 9.3458 12.773 9.39804Z" fill="#773EFA" />
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <!-- Navigation -->
                                    <div class="swiper-button-next shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2">
                                        <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>
                                    <div class="swiper-button-prev shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2">
                                        <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }


        <!-- Sản phẩm theo Nhà cung cấp -->
        <h2 class="text-sky-900 mb-3 font-medium uppercase"><a href="#">HOT DEAL</a> </h2>
        @await Component.InvokeAsync("MenuNews", new { menuType = "home" })
        <!-- Swiper -->
        <div class="relative mt-3">
            <div class="flash-sale-swiper list-product">
                <div class="swiper">
                    <div class="swiper-wrapper">
                    </div>
                </div>

                <!-- Navigation -->
                <div class="swiper-button-next shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2">
                    <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
                <div class="swiper-button-prev shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2">
                    <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </div>
            </div>
        </div>
        @* <div class="my-6 md:my-10"> *@
        @*     <h2 class="text-sky-900 mb-3 font-medium uppercase"><a href="#">HOT DEAL</a> </h2> *@
        @*     <ul class="flex flex-wrap gap-2"> *@
        @*         @foreach (var flashSale in Model) *@
        @*         { *@
        @*             // Kiểm tra xem Flash Sale có đang diễn ra không *@
        @*             var now = DateTime.UtcNow; *@
        @*             if (flashSale.fromdate <= now && flashSale.todate >= now) *@
        @*             { *@
        @*                 <li> *@
        @*                     <a href="javascript:void(0);" class="px-5 py-1 border border-gray-300 rounded-full inline-block supplier-filter" data-flashsale-id="@flashSale.flashsale_id"> *@
        @*                         @flashSale.name *@
        @*                     </a> *@
        @*                 </li> *@
        @*             } *@
        @*         } *@
        @*     </ul> *@
        @*     <!-- Swiper --> *@
        @*     <div class="relative mt-3"> *@
        @*         <div class="flash-sale-swiper"> *@
        @*             <div class="swiper"> *@
        @*                 <div class="swiper-wrapper" id="swiper-wrapper"> *@
        @*                     <!-- Các sản phẩm sẽ được render ở đây --> *@
        @*                 </div> *@
        @*             </div> *@
        @*             <!-- Navigation --> *@
        @*             <div class="swiper-button-next shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2"> *@
        @*                 <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"> *@
        @*                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /> *@
        @*                 </svg> *@
        @*             </div> *@
        @*             <div class="swiper-button-prev shadow !text-white !bg-white hover:!bg-white/70 rounded-full p-2"> *@
        @*                 <svg class="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"> *@
        @*                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /> *@
        @*                 </svg> *@
        @*             </div> *@
        @*         </div> *@
        @*     </div> *@
        @* </div> *@

    </div>

</section>

@section scripts {
    <script asp-append-version="true" type="text/javascript" src="~/modules/flashsale.js"></script>
    <!-- Thêm Swiper JS -->
    @* <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script> *@
}
