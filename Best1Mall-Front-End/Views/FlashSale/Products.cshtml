@using Best1Mall_Front_End.Models.Flashsale
@model FlashSaleProductsViewModel
@functions {
    string ToSeoUrl(string name)
    {
        return RemoveUnicode(RemoveSpecialCharacters(name)).Replace(" ", "-").ToLower();
    }

    string RemoveUnicode(string text)
    {
        var normalized = text.Normalize(System.Text.NormalizationForm.FormD);
        var chars = normalized.Where(c => System.Globalization.CharUnicodeInfo.GetUnicodeCategory(c) != System.Globalization.UnicodeCategory.NonSpacingMark);
        return new string(chars.ToArray()).Normalize(System.Text.NormalizationForm.FormC);
    }

    string RemoveSpecialCharacters(string input)
    {
        return System.Text.RegularExpressions.Regex.Replace(input, "[^a-zA-Z0-9\\s-]", "");
    }

    string FormatCurrency(double? amount)
    {
        return (amount.HasValue && amount > 0) ? string.Format("{0:#,0} đ", amount.Value) : "Giá liên hệ";
    }
    string GetFullImageUrl(string avatar)
    {
        if (string.IsNullOrEmpty(avatar))
        {
            return "/images/no-image.png"; // fallback ảnh mặc định
        }

        if (avatar.StartsWith("http") || avatar.StartsWith("data:image"))
        {
            return avatar; // Giữ nguyên nếu đã là URL hoặc base64
        }

        return "https://static-image.adavigo.com" + avatar; // Gắn domain tĩnh
    }
}

<section class="homepage">
    <div class="max-w-[1230px] mx-auto my-4 px-[15px]">
        <!-- Breadcrumb -->
        <div class="breadcrumb my-4">
            <ul class="flex items-center gap-3 font-normal">
                <li><a href="/">Trang chủ</a></li>
                <li><a href="/flashsale" class="text-color-base">Flashsale</a></li>
                <li><a href="" class="text-color-base">@Model.FlashSaleInfo?.name</a></li>
            </ul>
        </div>

        <!-- Kiểm tra nếu flash sale đang diễn ra -->
        @if (Model.FlashSaleInfo != null)
        {
            var now = DateTime.UtcNow; // Thời gian hiện tại (UTC)
            var flashSaleFromDate = Model.FlashSaleInfo.fromdate;
            var flashSaleToDate = Model.FlashSaleInfo.todate;

            if (flashSaleFromDate <= now && flashSaleToDate >= now)
            {
                // Hiển thị countdown
                <div class="flex items-center gap-2 justify-center">
                    <div class="h-[1px] bg-[#773EFA] w-[100px]"></div>
                    <img src="~/assets/images/flashsale-p.png" alt="" />
                    <span class="md:block hidden font-normal">Kết thúc trong</span>
                    <div id="countdown" class="flex gap-1 font-bold text-white">
                        <span class="bg-[#FF4169] px-2 py-1 rounded" id="hours">00</span>
                        <span class="text-[#FF4169]">:</span>
                        <span class="bg-[#FF4169] px-2 py-1 rounded" id="minutes">00</span>
                        <span class="text-[#FF4169]">:</span>
                        <span class="bg-[#FF4169] px-2 py-1 rounded" id="seconds">00</span>
                    </div>
                    <div class="h-[1px] bg-[#773EFA] w-[100px]"></div>
                </div>

                <!-- Banner Flash Sale -->
                <div class="relative">
                    <img src="@Model.FlashSaleInfo?.banner" alt=""
                         class="rounded-tl-xl rounded-tr-xl md:rounded-tl-3xl md:rounded-tr-3xl w-full">
                </div>

                <!-- List Products in Flash Sale -->
                <div class="grid lg:grid-cols-5 md:grid-cols-3 grid-cols-2 gap-3 mt-5">
                    @foreach (var product in Model.Products)
                    {
                        string seoUrl = $"/san-pham/{ToSeoUrl(product.name)}--{product._id}";
                        string discountText = $"-{product.discountvalue}%";
                        string ratingDisplay = (product.rating.HasValue && product.rating > 0) ? product.rating.Value.ToString("0.0") + "★" : "";
                        string reviewCountDisplay = (product.review_count.HasValue && product.review_count > 0) ? $"({product.review_count})" : "";
                        <div class="bg-white rounded-xl p-2 text-slate-800 relative border border-gray-100 h-full pb-14">
                            <a href="@seoUrl">
                                @if (product.super_sale == true)
                                {
                                    <div class="absolute -top-1 z-10 left-1 bg-[url(assets/images/icon/tag-sieusale.png)] bg-contain bg-no-repeat text-white text-xs px-2 w-[70px] h-[30px] py-1">
                                        Siêu Sale
                                    </div>
                                }
                                else
                                {
                                    <div class="absolute -top-1 z-10 left-1 bg-[url(assets/images/icon/tag1.png)] bg-contain bg-no-repeat text-white text-xs px-2 w-[50px] h-[30px] py-1">
                                        @discountText
                                    </div>
                                }
                                <div class="relative aspect-[1/1] overflow-hidden rounded-lg">
                                    <img src="@product.avatar" alt="@product.name" class="absolute inset-0 w-full h-full object-cover" />
                                </div>
                                <p class="text-sm line-clamp-2 font-medium mt-2">@product.name</p>
                                <div class="absolute bottom-2 w-full px-2 left-0">
                                    <div class="text-rose-600 font-bold mt-1">@String.Format("{0:N0}", product.amount_after_flashsale) đ</div>
                                    <div class="flex items-center justify-between">
                                        <div class="text-xs line-through text-slate-400">@String.Format("{0:N0}", product.amount) đ</div>
                                        <div class="text-xs text-yellow-500 mt-1">
                                            @Html.Raw(ratingDisplay) <span class="text-slate-400">@Html.Raw(reviewCountDisplay)</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center font-bold text-lg text-red-600">Flash Sale chưa bắt đầu hoặc đã kết thúc!</div>
            }
        }
    </div>
</section>


@section scripts {
    <script>
        const fromDate = '@(Model.FlashSaleInfo?.fromdate.ToString("yyyy-MM-ddTHH:mm:ss"))';
        const toDate = '@(Model.FlashSaleInfo?.todate.ToString("yyyy-MM-ddTHH:mm:ss"))';

        $(document).ready(function () {
           
            if (fromDate && toDate) {

                flashsale.StartCountdown(fromDate, toDate);
            }
        });
    </script>
     <script asp-append-version="true" type="text/javascript" src="~/modules/flashsale.js"></script> 
   
}

